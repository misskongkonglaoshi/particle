# Context
Filename: riper_task.md
Created On: $(date)
Created By: AI Assistant
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
Refactor the `VaporizationStage.m` file to correctly implement a three-point boundary value problem for magnesium particle combustion. The model should solve for gas-phase temperature and species profiles, along with three unknown parameters: flame radius (r_f) and two separate mass flow rates (m_dot1, m_dot2) for the inner and outer regions.

# Project Overview
The project simulates the combustion of a magnesium particle in a CO2 environment. The `VaporizationStage.m` is responsible for modeling the quasi-steady gas-phase combustion process, which is a key part of the overall simulation.

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)
The current implementation in `VaporizationStage.m` incorrectly configures the `bvp4c` solver for a two-point problem, while the physics requires a three-point problem structure (particle surface, flame front, ambient). The boundary condition function `bvp_bc` does not handle the internal boundary at the flame front (`r_f`) and its associated jump conditions. The number and application of boundary conditions are incorrect for solving the three unknown parameters (`r_f`, `mass_rate_1`, `mass_rate_2`).

# Proposed Solution (Populated by INNOVATE mode)
The solution is to restructure the BVP solver setup as a formal three-point problem.
1.  **Mesh:** Use a three-point mesh `[r_p, r_f, r_inf]` for `bvpinit`.
2.  **Parameters:** Treat `r_f`, `mass_rate_1`, and `mass_rate_2` as unknown parameters to be solved for by `bvp4c`.
3.  **System:** The ODE system remains a 10-variable, first-order system.
4.  **Boundary Conditions:** Implement a set of 13 physically-sound boundary conditions distributed across `r_p`, `r_f`, and `r_inf` to properly constrain the system and solve for the unknown parameters. This includes Dirichlet conditions at the outer boundaries, saturation and flux conditions at the particle surface, and flux jump conditions at the flame front.

# Implementation Plan (Generated by PLAN mode)
The refactoring will be performed by following these major steps:

1.  **Constants Definition**: Add necessary physical and chemical constants (e.g., molar masses for species) at the top of the `VaporizationStage.m` file or ensure they are accessible from `params`.
2.  **`solve_radial_bvp` Refactoring**:
    *   The `solinit` mesh will be explicitly defined as a three-point array: `[r_p, r_f_guess, r_inf]`.
    *   The call to `bvp4c` will be updated to pass a new boundary condition function handle suitable for a three-point problem: `@(y_rp, y_rf, y_rinf, p) bvp_bc(...)`.
    *   Helper objects/parameters (`pState`, `simParams`, `physicalModel`) will be passed through the function closures to `bvp_bc`.
3.  **`initial_guess` Creation**: A new helper function, `initial_guess`, will be created to provide a reasonable starting profile for the 10 state variables across the three-point mesh. This is crucial for solver convergence.
4.  **`bvp_bc` Rewrite**: The `bvp_bc` function will be completely rewritten with the new signature `function res = bvp_bc(y_rp, y_rf, y_rinf, params, ...)`. It will implement the 13 required boundary conditions:
    *   **At r_inf (5 conditions)**: Dirichlet conditions setting `T` and all four `Y_i` to their ambient values.
    *   **At r_p (2 conditions)**: Dirichlet condition for temperature (`T = T_p`) and setting the `Y_Mg` to its saturation value at `T_p`.
    *   **At r_f (6 conditions)**: One condition defining the flame (`Y_Mg` on the right side is zero), and five "jump" conditions that connect the fluxes (for energy and the four species) from the left side to the right side, accounting for the chemical reaction source terms.
5.  **`bvp_ode` Update**: The ODE function will be checked to ensure it correctly fetches temperature-dependent gas properties (`k`, `cp`, `rho*D`) for each region.
6.  **`particle_ode_system` Update**: This function will be updated to correctly extract the solved parameters (especially `mass_rate_1`) and surface gradients from the `bvp4c` solution object (`sol`) to calculate the particle's mass and temperature change over time.
7.  **Helper Function**: A new helper function, `calculate_saturation_Y`, will be added to compute the mass fraction of Mg corresponding to its saturation vapor pressure at a given temperature.

### Implementation Checklist:
1.  Define molar masses (W_i) for Mg, MgO, CO, CO2 as constants within the class.
2.  In `solve_radial_bvp`, modify the setup to use a three-point mesh `[r_p, r_f_guess, r_inf]` and update the `bvpinit` and `bvp4c` calls.
3.  Create the new `initial_guess` helper function to provide initial profiles for the 10 state variables.
4.  Completely rewrite the `bvp_bc` function with the new three-point signature.
5.  In `bvp_bc`, implement the 5 Dirichlet boundary conditions at `r_inf`.
6.  In `bvp_bc`, implement the 2 boundary conditions at `r_p` (fixed `T_p` and saturated `Y_Mg`).
7.  In `bvp_bc`, implement the flame definition condition: `Y_Mg(at r_f, right side) = 0`.
8.  In `bvp_bc`, implement the energy flux jump condition at `r_f`.
9.  In `bvp_bc`, implement the 4 mass flux jump conditions (for Mg, MgO, CO, CO2) at `r_f`.
10. In `bvp_ode`, ensure temperature-dependent properties (`k`, `cp`, `rho_D_species`) are correctly fetched from the `physicalModel`.
11. In `particle_ode_system`, correctly extract solved parameters and surface gradients from the `sol` object to compute `dydt`.
12. Create the `calculate_saturation_Y` helper function.

# Current Execution Step (Updated by EXECUTE mode when starting a step)
> Currently executing: "Applying full refactoring of the BVP solver based on the 12-point implementation checklist."

# Task Progress (Appended by EXECUTE mode after each step completion)

# Final Review (Populated by REVIEW mode) 